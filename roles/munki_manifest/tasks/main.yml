---
# creates/updates a munki manifest from given manifest_list for autopkg

- name: Check if {{ manifest_name }} exists
  stat: path={{ repo_path }}/manifests/{{ manifest_name }} follow=true
  register: manifest_exists

- name: Create new munki manifest {{ manifest_name }}
  command: "{{ manifestutil_exec }} new-manifest {{ manifest_name }}"
  when: manifest_exists.stat.exists == false

- name: Add items to munki manifest {{ manifest_name }}
  command: "{{ manifestutil_exec }} add-pkg {{ item }} --manifest {{ manifest_name }} --section optional_installs"
# need to inline strip .munki from pkg_list
#  command: "{{ manifestutil_exec }} add-pkg {{ item | regex_replace('\\.munki ', '\\ ') }} --manifest {{ manifest_name }} --section optional_installs"
  with_items: manifest_list
